<div class="app">
  <div class="header">
    <div class="badge">PDF Annotator</div>
    <input class="input" type="file" accept="application/pdf" (change)="onFileSelected($event)" />

    <div class="controls">
      <button class="btn" (click)="prevPage()" [disabled]="!pdfDoc || pageIndex() === 1">◀ Prev</button>
      <div class="badge">Page {{ pageIndex() }} / {{ pageCount || 0 }}</div>
      <button class="btn" (click)="nextPage()" [disabled]="!pdfDoc || pageIndex() === pageCount">Next ▶</button>

      <button class="btn" (click)="zoomOut()" [disabled]="!pdfDoc">−</button>
      <div class="badge">Zoom {{ scale() | number:'1.0-2' }}×</div>
      <button class="btn" (click)="zoomIn()" [disabled]="!pdfDoc">+</button>

      <button class="btn" (click)="clearAll()" [disabled]="!coords().length">Clear</button>
      <button class="btn" (click)="copyJSON()" [disabled]="!coords().length">Copy JSON</button>
      <button class="btn" (click)="downloadJSON()" [disabled]="!coords().length">Download JSON</button>
    </div>
  </div>

  <div class="panel sidebar">
    <div class="small">Anotaciones (JSON)</div>
    <hr />
    <pre class="json">{{ coords() | json }}</pre>
  </div>

  <div class="panel viewer" *ngIf="pdfDoc as _">
    <div class="canvas-wrap" style="position:relative;">
      <canvas #pdfCanvas id="pdfCanvas"></canvas>
      <canvas #overlayCanvas id="overlayCanvas" style="position:absolute; inset:0; pointer-events:none;"></canvas>

      <!-- capa de anotaciones interactivas (no bloquea clics del hitbox) -->
      <div #annotationsLayer class="annotations-layer"
        style="position:absolute; inset:0; z-index:6; pointer-events:none;"></div>

      <!-- Hitbox para clicks en PDF -->
      <div class="hitbox" (click)="onHitboxClick($event)"
        style="position:absolute; inset:0; z-index:5; cursor:crosshair;">
      </div>

      <!-- Preview flotante -->
      <div *ngIf="preview() as p" class="preview"
        [style.left.%]="(p.x * scale() / pdfCanvasRef!.nativeElement.width) * 100"
        [style.top.%]="(1 - (p.y * scale()) / pdfCanvasRef!.nativeElement.height) * 100"
        style="position:absolute; z-index:10; background:white; padding:6px; border:1px solid #ccc; border-radius:4px;">
        <input type="text" [(ngModel)]="p.value" placeholder="Texto..." />
        <input type="number" [(ngModel)]="p.size" min="8" max="72" />
        <input type="color" [(ngModel)]="p.color" />
        <button (click)="confirmPreview()">✅</button>
        <button (click)="cancelPreview()">❌</button>
      </div>
    </div>
  </div>

  <div class="panel viewer" *ngIf="!pdfDoc">
    <p class="small">Sube un PDF y haz click donde quieras añadir texto. Haz clic en un texto ya anotado para
      editarlo o borrarlo.</p>
  </div>
</div>