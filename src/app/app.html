<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">{{ 'app.title' | t }}</div>
    <input type="file" accept="application/pdf" (change)="onFileSelected($event)" class="input-file" />

    <div class="controls">
      <input
        #coordsFileInput
        type="file"
        accept="application/json"
        (change)="onCoordsFileSelected($event)"
        hidden
      />
      <button class="btn" (click)="prevPage()" [disabled]="!pdfDoc || pageIndex()===1">‚óÄ
        {{ 'controls.prev' | t }}</button>
      <span
        class="page-indicator">{{ 'controls.pageIndicator' | t : { current: pageIndex(), total: pageCount || 0 } }}</span>
      <button class="btn" (click)="nextPage()" [disabled]="!pdfDoc || pageIndex()===pageCount">{{ 'controls.next' | t }}
        ‚ñ∂</button>

      <button class="btn" (click)="zoomOut()" [disabled]="!pdfDoc">‚àí</button>
      <span class="page-indicator">{{ 'controls.zoomLabel' | t }} {{ scale() | number:'1.0-2' }}√ó</span>
      <button class="btn" (click)="zoomIn()" [disabled]="!pdfDoc">+</button>

      <button class="btn danger" (click)="clearAll()" [disabled]="!coords().length">{{ 'controls.clear' | t }}</button>
      <button class="btn" (click)="copyJSON()" [disabled]="!coords().length">{{ 'controls.copyJson' | t }}</button>
      <button class="btn" (click)="downloadJSON()"
        [disabled]="!coords().length">{{ 'controls.downloadJson' | t }}</button>
      <button class="btn" (click)="downloadAnnotatedPDF()"
        [disabled]="!coords().length || !pdfDoc">{{ 'controls.downloadPdf' | t }}</button>
    </div>

    <div class="language-selector">
      <label for="language-select">{{ 'app.languageLabel' | t }}</label>
      <select id="language-select" [(ngModel)]="languageModel" (ngModelChange)="onLanguageChange($event)"
        [attr.aria-label]="'app.languageAriaLabel' | t">
        <option *ngFor="let lang of languages" [value]="lang">{{ ('app.languages.' + lang) | t }}</option>
      </select>

    </div>
  </header>

  <!-- LATERAL SIDEBAR -->
  <aside class="sidebar">
    <h4>{{ 'sidebar.title' | t }}</h4>
    <div class="sidebar-actions">
      <button type="button" class="btn" (click)="triggerImportCoords()" [disabled]="!pdfDoc">
        {{ 'sidebar.importJsonFile' | t }}
      </button>
      <button type="button" class="btn" (click)="applyCoordsText()">
        {{ 'sidebar.applyJson' | t }}
      </button>
    </div>
    <textarea
      class="json-editor"
      [(ngModel)]="coordsTextModel"
      [placeholder]="'sidebar.jsonPlaceholder' | t"
      spellcheck="false"
    ></textarea>
    <small class="sidebar-hint">{{ 'sidebar.jsonHint' | t }}</small>
  </aside>

  <!-- VISOR PDF -->
  <main class="viewer" *ngIf="pdfDoc as _">
    <div class="canvas-container">
      <canvas #pdfCanvas></canvas>
      <canvas #overlayCanvas></canvas>
      <div #annotationsLayer class="annotations-layer"></div>
      <div class="hitbox" (click)="onHitboxClick($event)"></div>

      <!-- NUEVA ANOTACI√ìN -->
      <div *ngIf="preview() as p" class="annotation-editor" #previewEditor [style.left.px]="p.field.x*scale()"
        [style.top.px]="pdfCanvasRef!.nativeElement.height - p.field.y*scale()"
        (keydown)="onEditorKeydown($event, 'preview')">
        <label class="field">
          <span class="field-label">{{ 'annotation.fields.text.label' | t }}</span>
          <input type="text" [(ngModel)]="p.field.mapField"
            [placeholder]="'annotation.fields.text.placeholder' | t" />
        </label>
        <div class="font-section">
          <span class="field-label">{{ 'annotation.fields.font.label' | t }}</span>
          <div class="font-picker" #previewFontPicker [class.open]="previewFontPickerOpen">
            <ng-container *ngIf="resolveFontOption(p.field.fontType) as previewFont">
              <button
                type="button"
                class="font-picker__toggle"
                (click)="togglePreviewFontPicker()"
                [attr.aria-expanded]="previewFontPickerOpen"
                [attr.aria-label]="'annotation.fields.font.label' | t"
                [style.font-family]="previewFont.family"
              >
                <span class="font-picker__current">{{ previewFont.label }}</span>
                <span class="font-picker__chevron" aria-hidden="true">‚ñæ</span>
              </button>
              <div class="font-picker__panel" *ngIf="previewFontPickerOpen">
                <input
                  #previewFontSearch
                  type="search"
                  class="font-picker__search"
                  [(ngModel)]="previewFontFilter"
                  [placeholder]="'annotation.fields.font.searchPlaceholder' | t"
                  (keydown)="onFontSearchKeydown($event, 'preview')"
                />
                <ng-container *ngIf="filterFontOptions(previewFontFilter) as previewFonts">
                  <div class="font-picker__options" *ngIf="previewFonts.length; else previewFontEmpty">
                    <button
                      type="button"
                      class="font-picker__option"
                      *ngFor="let font of previewFonts"
                      (click)="setPreviewFont(font.id)"
                      [class.active]="normalizeFontType(p.field.fontType)===font.id"
                      [style.font-family]="font.family"
                    >
                      <span class="font-picker__option-label">{{ font.label }}</span>
                      <span class="font-picker__option-preview">Aa</span>
                    </button>
                  </div>
                </ng-container>
                <ng-template #previewFontEmpty>
                  <p class="font-picker__empty">{{ 'annotation.fields.font.noResults' | t }}</p>
                </ng-template>
              </div>
            </ng-container>
          </div>
        </div>
        <label class="field field-small">
          <span class="field-label">{{ 'annotation.fields.size.label' | t }}</span>
          <input type="number" [(ngModel)]="p.field.fontSize" min="8" max="72" />
        </label>
        <div class="color-section">
          <span class="field-label">{{ 'annotation.fields.color.label' | t }}</span>
          <div class="color-row">
            <input type="color" [(ngModel)]="p.field.color" (ngModelChange)="onPreviewColorPicker($event)" />
            <div class="color-inputs">
              <input type="text" [ngModel]="previewHexInput()" (ngModelChange)="setPreviewColorFromHex($event)"
                [ngModelOptions]="{ standalone: true }" [placeholder]="'annotation.color.hexPlaceholder' | t" />
              <input type="text" [ngModel]="previewRgbInput()" (ngModelChange)="setPreviewColorFromRgb($event)"
                [ngModelOptions]="{ standalone: true }" [placeholder]="'annotation.color.rgbPlaceholder' | t" />
            </div>
          </div>
          <small class="color-hint">{{ 'annotation.color.hintPreview' | t }}</small>
        </div>
        <div class="editor-actions">
          <button (click)="confirmPreview()">‚úÖ</button>
          <button (click)="cancelPreview()">‚ùå</button>
        </div>
      </div>

      <!-- EDITAR ANOTACI√ìN -->
      <div *ngIf="editing() as e" class="annotation-editor editing" #editEditor [style.left.px]="e.field.x*scale()"
        [style.top.px]="pdfCanvasRef!.nativeElement.height - e.field.y*scale()"
        (keydown)="onEditorKeydown($event, 'edit')">
        <span class="editor-badge">{{ 'annotation.editingBadge' | t }}</span>
        <label class="field">
          <span class="field-label">{{ 'annotation.fields.text.label' | t }}</span>
          <input type="text" [(ngModel)]="e.field.mapField"
            [placeholder]="'annotation.fields.text.placeholder' | t" />
        </label>
        <div class="font-section">
          <span class="field-label">{{ 'annotation.fields.font.label' | t }}</span>
          <div class="font-picker" #editFontPicker [class.open]="editFontPickerOpen">
            <ng-container *ngIf="resolveFontOption(e.field.fontType) as editFont">
              <button
                type="button"
                class="font-picker__toggle"
                (click)="toggleEditFontPicker()"
                [attr.aria-expanded]="editFontPickerOpen"
                [attr.aria-label]="'annotation.fields.font.label' | t"
                [style.font-family]="editFont.family"
              >
                <span class="font-picker__current">{{ editFont.label }}</span>
                <span class="font-picker__chevron" aria-hidden="true">‚ñæ</span>
              </button>
              <div class="font-picker__panel" *ngIf="editFontPickerOpen">
                <input
                  #editFontSearch
                  type="search"
                  class="font-picker__search"
                  [(ngModel)]="editFontFilter"
                  [placeholder]="'annotation.fields.font.searchPlaceholder' | t"
                  (keydown)="onFontSearchKeydown($event, 'edit')"
                />
                <ng-container *ngIf="filterFontOptions(editFontFilter) as editFonts">
                  <div class="font-picker__options" *ngIf="editFonts.length; else editFontEmpty">
                    <button
                      type="button"
                      class="font-picker__option"
                      *ngFor="let font of editFonts"
                      (click)="setEditFont(font.id)"
                      [class.active]="normalizeFontType(e.field.fontType)===font.id"
                      [style.font-family]="font.family"
                    >
                      <span class="font-picker__option-label">{{ font.label }}</span>
                      <span class="font-picker__option-preview">Aa</span>
                    </button>
                  </div>
                </ng-container>
                <ng-template #editFontEmpty>
                  <p class="font-picker__empty">{{ 'annotation.fields.font.noResults' | t }}</p>
                </ng-template>
              </div>
            </ng-container>
          </div>
        </div>
        <label class="field field-small">
          <span class="field-label">{{ 'annotation.fields.size.label' | t }}</span>
          <input type="number" [(ngModel)]="e.field.fontSize" min="8" max="72" />
        </label>
        <div class="color-section">
          <span class="field-label">{{ 'annotation.fields.color.label' | t }}</span>
          <div class="color-row">
            <input type="color" [(ngModel)]="e.field.color" (ngModelChange)="onEditColorPicker($event)" />
            <div class="color-inputs">
              <input type="text" [ngModel]="editHexInput()" (ngModelChange)="setEditColorFromHex($event)"
                [ngModelOptions]="{ standalone: true }" [placeholder]="'annotation.color.hexPlaceholder' | t" />
              <input type="text" [ngModel]="editRgbInput()" (ngModelChange)="setEditColorFromRgb($event)"
                [ngModelOptions]="{ standalone: true }" [placeholder]="'annotation.color.rgbPlaceholder' | t" />
            </div>
          </div>
          <small class="color-hint">{{ 'annotation.color.hintEdit' | t }}</small>
        </div>
        <div class="editor-actions">
          <button (click)="confirmEdit()">‚úÖ</button>
          <button (click)="cancelEdit()">‚ùå</button>
          <button class="btn-delete" (click)="deleteAnnotation()">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  </main>

  <main class="viewer empty" *ngIf="!pdfDoc">
    <p class="empty-text">{{ 'viewer.emptyMessage' | t }}</p>
  </main>

  <footer class="footer">
    <div class="footer__brand">
      <img class="footer__logo" src="/logo.svg" [attr.alt]="'Logotipo de ' + appName" />
      <div class="footer__brand-text">
        <span class="footer__app-name">{{ appName }}</span>
        <span class="footer__version">v{{ version }}</span>
      </div>
    </div>
    <div class="footer__details">
      <span>¬© {{ currentYear }} {{ appName }}</span>
      <span>Desarrollado por {{ appAuthor }}</span>
    </div>
  </footer>
</div>