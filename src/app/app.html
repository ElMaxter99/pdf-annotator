<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">PDF Annotator</div>
    <input type="file" accept="application/pdf" (change)="onFileSelected($event)" class="input-file" />

    <div class="controls">
      <button class="btn" (click)="prevPage()" [disabled]="!pdfDoc || pageIndex()===1">‚óÄ Prev</button>
      <span class="page-indicator">Page {{ pageIndex() }} / {{ pageCount || 0 }}</span>
      <button class="btn" (click)="nextPage()" [disabled]="!pdfDoc || pageIndex()===pageCount">Next ‚ñ∂</button>

      <button class="btn" (click)="zoomOut()" [disabled]="!pdfDoc">‚àí</button>
      <span class="page-indicator">Zoom {{ scale() | number:'1.0-2' }}√ó</span>
      <button class="btn" (click)="zoomIn()" [disabled]="!pdfDoc">+</button>

      <button class="btn danger" (click)="clearAll()" [disabled]="!coords().length">Clear</button>
      <button class="btn" (click)="copyJSON()" [disabled]="!coords().length">Copy JSON</button>
      <button class="btn" (click)="downloadJSON()" [disabled]="!coords().length">Download JSON</button>
    </div>
  </header>

  <!-- LATERAL SIDEBAR -->
  <aside class="sidebar">
    <h4>Anotaciones (JSON)</h4>
    <pre class="json">{{ coords() | json }}</pre>
  </aside>

  <!-- VISOR PDF -->
  <main class="viewer" *ngIf="pdfDoc as _">
    <div class="canvas-container">
      <canvas #pdfCanvas></canvas>
      <canvas #overlayCanvas></canvas>
      <div #annotationsLayer class="annotations-layer"></div>
      <div class="hitbox" (click)="onHitboxClick($event)"></div>

      <!-- NUEVA ANOTACI√ìN -->
      <div *ngIf="preview() as p" class="annotation-editor" #previewEditor [style.left.px]="p.x*scale()"
        [style.top.px]="pdfCanvasRef!.nativeElement.height - p.y*scale()"
        (keydown)="onEditorKeydown($event, 'preview')">
        <label class="field">
          <span class="field-label">Texto</span>
          <input type="text" [(ngModel)]="p.value" placeholder="Texto..." />
        </label>
        <label class="field field-small">
          <span class="field-label">Tama√±o</span>
          <input type="number" [(ngModel)]="p.size" min="8" max="72" />
        </label>
        <div class="color-section">
          <span class="field-label">Color</span>
          <div class="color-row">
            <input type="color" [(ngModel)]="p.color" (ngModelChange)="onPreviewColorPicker($event)" />
            <div class="color-inputs">
              <input type="text" [ngModel]="previewHexInput()" (ngModelChange)="setPreviewColorFromHex($event)"
                [ngModelOptions]="{ standalone: true }" placeholder="#5eead4" />
              <input type="text" [ngModel]="previewRgbInput()" (ngModelChange)="setPreviewColorFromRgb($event)"
                [ngModelOptions]="{ standalone: true }" placeholder="rgb(94, 234, 212)" />
            </div>
          </div>
          <small class="color-hint">Selecciona un color, escribe un HEX o un RGB. El JSON siempre exportar√° el color en
            HEX.</small>
        </div>
        <div class="editor-actions">
          <button (click)="confirmPreview()">‚úÖ</button>
          <button (click)="cancelPreview()">‚ùå</button>
        </div>
      </div>

      <!-- EDITAR ANOTACI√ìN -->
      <div *ngIf="editing() as e" class="annotation-editor editing" #editEditor [style.left.px]="e.coord.x*scale()"
        [style.top.px]="pdfCanvasRef!.nativeElement.height - e.coord.y*scale()"
        (keydown)="onEditorKeydown($event, 'edit')">
        <span class="editor-badge">Editando</span>
        <label class="field">
          <span class="field-label">Texto</span>
          <input type="text" [(ngModel)]="e.coord.value" placeholder="Texto..." />
        </label>
        <label class="field field-small">
          <span class="field-label">Tama√±o</span>
          <input type="number" [(ngModel)]="e.coord.size" min="8" max="72" />
        </label>
        <div class="color-section">
          <span class="field-label">Color</span>
          <div class="color-row">
            <input type="color" [(ngModel)]="e.coord.color" (ngModelChange)="onEditColorPicker($event)" />
            <div class="color-inputs">
              <input type="text" [ngModel]="editHexInput()" (ngModelChange)="setEditColorFromHex($event)"
                [ngModelOptions]="{ standalone: true }" placeholder="#5eead4" />
              <input type="text" [ngModel]="editRgbInput()" (ngModelChange)="setEditColorFromRgb($event)"
                [ngModelOptions]="{ standalone: true }" placeholder="rgb(94, 234, 212)" />
            </div>
          </div>
          <small class="color-hint">Puedes pegar un HEX o un RGB existente para reutilizar colores exactos.</small>
        </div>
        <div class="editor-actions">
          <button (click)="confirmEdit()">‚úÖ</button>
          <button (click)="cancelEdit()">‚ùå</button>
          <button class="btn-delete" (click)="deleteAnnotation()">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  </main>

  <main class="viewer empty" *ngIf="!pdfDoc">
    <p class="empty-text">Sube un PDF y haz click donde quieras a√±adir anotaciones. Ed√≠talas en la vista previa antes de
      confirmar ‚úÖ.</p>
  </main>
</div>